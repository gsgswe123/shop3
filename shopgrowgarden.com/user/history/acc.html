<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tài khoản - Shop Grow A Garden</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAANCSURBVFiFtZc9aBRBFMd/M7ubTWI0GoM2NmIhFlYWYmVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVhYWVh">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #e63946;
            --secondary-color: #1d3557;
            --accent-color: #a8dadc;
            --light-color: #f1faee;
            --dark-color: #1b1a1a;
            --gray-color: #6c757d;
            --success-color: #2a9d8f;
            --warning-color: #f4a261;
            --danger-color: #dc3545;
            --border-color: #dee2e6;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.1);
            --border-radius: 16px;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient-primary: linear-gradient(135deg, #e63946 0%, #d62839 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--dark-color);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(1deg); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header with Glass Effect */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            height: 50px;
            transition: var(--transition);
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        .logo:hover {
            transform: scale(1.05) rotate(2deg);
        }

        .nav-menu {
            display: flex;
            gap: 25px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            transition: var(--transition);
            font-weight: 500;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .nav-link.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        /* User Actions */
        .user-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-dropdown {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 12px 20px;
            border-radius: 50px;
            transition: var(--transition);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }

        .user-dropdown:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            box-shadow: var(--shadow-md);
        }

        .user-name {
            font-weight: 600;
            color: white;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 15px);
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            min-width: 220px;
            padding: 15px 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-15px) scale(0.95);
            transition: var(--transition);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .user-dropdown:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 25px;
            color: var(--dark-color);
            text-decoration: none;
            transition: var(--transition);
            background: none;
            border: none;
            width: 100%;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background: rgba(230, 57, 70, 0.1);
            color: var(--primary-color);
            transform: translateX(5px);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 10px 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            background: none;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-outline {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            padding: 40px 0;
            min-height: calc(100vh - 200px);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .breadcrumb a {
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }

        .breadcrumb a:hover {
            color: var(--accent-color);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .account-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 40px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        /* Sidebar with Advanced Glass Effect */
        .account-sidebar {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: var(--border-radius);
            padding: 35px 25px;
            box-shadow: var(--shadow-xl);
            height: fit-content;
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .account-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 35px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .account-avatar {
            width: 90px;
            height: 90px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 700;
            margin: 0 auto 20px;
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        .account-avatar::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: conic-gradient(from 0deg, var(--primary-color), var(--accent-color), var(--primary-color));
            border-radius: 50%;
            z-index: -1;
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            to { transform: rotate(360deg); }
        }

        .account-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .account-id {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-menu {
            margin-bottom: 35px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: var(--transition);
            font-weight: 500;
            cursor: pointer;
            background: none;
            border: none;
            width: 100%;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s;
        }

        .menu-item:hover::before {
            left: 100%;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(8px);
        }

        .menu-item.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .menu-item i {
            width: 22px;
            text-align: center;
            font-size: 16px;
        }

        /* Content Area with Glass Effect */
        .account-content {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: var(--border-radius);
            padding: 40px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .account-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .content-header {
            margin-bottom: 35px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .content-title {
            font-size: 28px;
            color: white;
            margin: 0;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .tab-content {
            display: none;
            animation: fadeInScale 0.6s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Account Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .info-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .info-label {
            display: block;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 16px;
            color: white;
            font-weight: 600;
        }

        /* Balance Card */
        .balance-card {
            background: var(--gradient-primary);
            border-radius: var(--border-radius);
            padding: 40px;
            margin-bottom: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: rotate 10s linear infinite;
        }

        .balance-amount {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 25px;
            color: white;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .balance-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .balance-actions .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }

        .balance-actions .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-3px);
        }

        /* Quick Deposit */
        .quick-deposit {
            margin-top: 30px;
        }

        .quick-deposit h3 {
            color: white;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .quick-amount {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: white;
            backdrop-filter: blur(10px);
        }

        .quick-amount:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .quick-amount.selected {
            background: var(--gradient-primary);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: var(--shadow-lg);
        }

        /* History and Empty States */
        .history-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .history-list > .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(10px);
        }
        
        .history-item.pending {
             opacity: 0.7;
        }

        .history-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 18px;
        }
        
        .history-icon i.fa-spin {
             animation: spin 1.5s linear infinite;
        }
        
        .history-icon.pending {
             background: rgba(108, 117, 125, 0.2);
             color: var(--gray-color);
        }
        
        .history-icon.success { /* deposit */
            background: rgba(42, 157, 143, 0.2);
            color: var(--success-color);
        }

        .history-icon.failed {
             background: rgba(220, 53, 69, 0.2);
             color: var(--danger-color);
        }

        .history-icon.purchase {
            background: rgba(230, 57, 70, 0.2);
            color: var(--primary-color);
        }

        .history-details {
            flex: 1;
        }
        
        .history-status {
             font-size: 13px;
             font-style: italic;
             margin-top: 4px;
        }

        .history-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: white;
        }

        .history-date, .history-info {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .history-amount {
            font-size: 18px;
            font-weight: 700;
        }

        .history-amount.failed, .history-amount.pending {
            color: var(--gray-color);
        }

        /* Security Settings */
        .security-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 15px;
            transition: var(--transition);
        }

        .security-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .security-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .security-info i {
            font-size: 24px;
            color: var(--primary-color);
            width: 30px;
            text-align: center;
        }

        .security-info h4 {
            margin-bottom: 5px;
            font-size: 16px;
            color: white;
            font-weight: 600;
        }

        .security-info p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 25px;
            opacity: 0.6;
            color: white;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: white;
            font-size: 24px;
            font-weight: 600;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 30px;
        }

        /* Login Prompt */
        .login-prompt {
            text-align: center;
            padding: 80px 40px;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: var(--border-radius);
            margin: 60px 0;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-xl);
            animation: bounceIn 1s ease-out;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .login-prompt i {
            font-size: 80px;
            color: white;
            margin-bottom: 30px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .login-prompt h2 {
            color: white;
            margin-bottom: 20px;
            font-size: 32px;
            font-weight: 700;
        }

        .login-prompt p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 40px;
            font-size: 18px;
        }

        .login-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Footer */
        .footer {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            color: white;
            padding: 60px 0 30px;
            margin-top: 80px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-logo {
            text-align: center;
            padding: 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
        }

        .footer-logo img {
            max-width: 160px;
            margin-bottom: 20px;
            filter: brightness(1.2);
        }

        .footer-title {
            font-size: 20px;
            margin-bottom: 25px;
            position: relative;
            padding-bottom: 15px;
            font-weight: 600;
        }

        .footer-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }

        .footer-links {
            list-style: none;
        }

        .footer-link {
            margin-bottom: 12px;
        }

        .footer-link a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
        }

        .footer-link a:hover {
            color: white;
            transform: translateX(8px);
        }

        .footer-bottom {
            text-align: center;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        /* Messenger Chat Button */
        .messenger-chat {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #0084ff, #006ce7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0, 132, 255, 0.4);
            cursor: pointer;
            transition: var(--transition);
            z-index: 1000;
            text-decoration: none;
            color: white;
            animation: pulse 3s ease-in-out infinite;
        }

        .messenger-chat:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 132, 255, 0.5);
            color: white;
        }

        .messenger-chat i {
            font-size: 28px;
        }

        .messenger-chat .tooltip {
            position: absolute;
            right: 85px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .messenger-chat .tooltip::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            margin-top: -6px;
            border: 6px solid transparent;
            border-left-color: rgba(0, 0, 0, 0.9);
        }

        .messenger-chat:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 650px; /* ** MỚI ** */
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.8);
            transition: transform 0.3s ease;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-xl);
            display: flex; /* ** MỚI ** */
            flex-direction: column; /* ** MỚI ** */
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }

        .modal-title {
            font-size: 28px;
            margin-bottom: 30px;
            color: white;
            text-align: center;
            font-weight: 700;
        }
        
        .modal-header, .modal-footer {
             flex-shrink: 0; /* ** MỚI ** */
        }
        .modal-body {
            flex-grow: 1; /* ** MỚI ** */
            overflow-y: auto; /* ** MỚI ** */
            margin-bottom: 20px; /* ** MỚI ** */
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: white;
            font-size: 15px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 16px;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(230, 57, 70, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group.has-error input,
        .form-group.has-error select {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.2);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 14px;
            margin-top: 8px;
            display: none;
            font-weight: 500;
        }

        .form-group.has-error .error-message {
            display: block;
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .password-group {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: rgba(255, 255, 255, 0.6);
            transition: var(--transition);
            font-size: 18px;
        }

        .password-toggle:hover {
            color: white;
        }
        
        .password-strength-container {
            margin-top: 15px;
        }
        
        #passwordStrengthMeter {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            transition: var(--transition);
        }
        
        #passwordStrengthBar {
            height: 100%;
            width: 0;
            border-radius: 4px;
            transition: width 0.4s ease, background-color 0.4s ease;
        }
        
        #passwordStrengthBar.weak { background-color: var(--danger-color); }
        #passwordStrengthBar.medium { background-color: var(--warning-color); }
        #passwordStrengthBar.strong { background-color: var(--success-color); }
        #passwordStrengthBar.very-strong { background-color: #2a7f9d; } /* Custom strong color */

        #passwordCriteria {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        #passwordCriteria li {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: color 0.3s ease;
        }

        #passwordCriteria li.valid {
            color: var(--success-color);
        }

        #passwordCriteria li i {
            width: 16px;
            text-align: center;
        }


        .btn-submit {
            width: 100%;
            padding: 18px;
            font-size: 16px;
            font-weight: 700;
            position: relative;
            margin-top: 20px;
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            display: none;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        .btn-submit.loading > .spinner {
            display: inline-block;
        }
        
        .btn-submit.loading > span {
            vertical-align: middle;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Card Types */
        .card-types {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .card-type {
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .card-type:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .card-type.selected {
            border-color: var(--primary-color);
            background: rgba(230, 57, 70, 0.1);
            box-shadow: var(--shadow-lg);
        }

        .card-type .card-logo {
            width: 100%;
            max-width: 45px;
            height: 35px;
            border-radius: 6px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 13px;
        }

        .card-type[data-type="viettel"] .card-logo {
            background: #d70018;
        }

        .card-type[data-type="mobifone"] .card-logo {
            background: #1f7a3e;
        }

        .card-type[data-type="vinaphone"] .card-logo {
            background: #662d91;
        }

        .card-type[data-type="gate"] .card-logo {
            background: #ff6600;
        }

        .card-type span {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .form-note {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(42, 157, 143, 0.15);
            border-radius: 12px;
            font-size: 14px;
            color: var(--success-color);
            border: 1px solid rgba(42, 157, 143, 0.3);
        }

        .form-note i {
            color: var(--success-color);
            font-size: 16px;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 20px 25px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow-xl);
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10000;
            max-width: 400px;
            backdrop-filter: blur(15px);
        }

        .toast > div {
             display: flex;
             align-items: center;
             justify-content: space-between;
             gap: 15px;
        }
        .toast > div > span {
            line-height: 1.4;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            background: rgba(42, 157, 143, 0.9);
            border: 1px solid rgba(42, 157, 143, 0.3);
        }

        .toast.error {
            background: rgba(220, 53, 69, 0.9);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .toast.info {
            background: rgba(59, 130, 246, 0.9);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .toast.warning {
            background: rgba(245, 158, 11, 0.9);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* ** MỚI: CSS cho danh sách thiết bị trong modal ** */
        .device-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .device-item {
            display: flex;
            align-items: center;
            padding: 18px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s;
        }
        .device-item:last-child {
            border-bottom: none;
        }
        .device-item.current-device {
            background: rgba(42, 157, 143, 0.15);
            border-left: 4px solid var(--success-color);
            padding-left: 11px;
        }
        .device-icon {
            font-size: 32px;
            color: rgba(255, 255, 255, 0.9);
            width: 50px;
            text-align: center;
            margin-right: 20px;
        }
        .device-details {
            flex-grow: 1;
        }
        .device-name {
            font-weight: 600;
            color: white;
            font-size: 16px;
        }
        .device-meta {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }
        .device-meta .current-tag {
            color: var(--success-color);
            font-weight: bold;
        }
        .device-logout-btn {
            padding: 8px 16px;
            font-size: 13px;
        }
        .modal-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .account-layout {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .account-sidebar {
                display: flex;
                align-items: center;
                text-align: left;
                padding: 25px;
            }

            .sidebar-header {
                display: flex;
                align-items: center;
                margin: 0 30px 0 0;
                text-align: left;
            }

            .account-avatar {
                margin: 0 20px 0 0;
                width: 70px;
                height: 70px;
                font-size: 28px;
            }

            .sidebar-menu {
                display: flex;
                gap: 15px;
                margin: 0;
                flex-wrap: wrap;
                flex: 1;
            }

            .menu-item {
                margin: 0;
                padding: 12px 18px;
                border-radius: 25px;
                white-space: nowrap;
            }
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 20px;
            }

            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .balance-actions {
                flex-direction: column;
                gap: 15px;
            }

            .login-actions {
                flex-direction: column;
                gap: 15px;
            }

            .messenger-chat {
                bottom: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
            }

            .messenger-chat i {
                font-size: 24px;
            }

            .messenger-chat .tooltip {
                display: none;
            }

            .card-types {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .sidebar-header {
                flex-direction: column;
                text-align: center;
            }

            .account-avatar {
                margin: 0 0 15px 0;
            }

            .sidebar-menu {
                justify-content: center;
            }

            .quick-amounts {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                padding: 30px 20px;
            }
            .device-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .device-logout-btn {
                align-self: flex-end;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            transition: var(--transition);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container header-container">
            <a href="index.html">
                <img src="https://i.ibb.co/q3r1hTft/8574d186247eba75669b7d50d42bd650-png.png" alt="Shop Grow A Garden" class="logo">
            </a>
            
            <nav class="nav-menu">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Trang Chủ</span>
                </a>
            </nav>

            <div class="user-actions">
                <!-- User dropdown (shown when logged in) -->
                <div class="user-dropdown" id="userDropdown" style="display: none;">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span class="user-name" id="userName">User</span>
                    <div class="dropdown-menu">
                        <a href="acc.html" class="dropdown-item">
                            <i class="fas fa-user"></i>
                            <span>Tài khoản</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" onclick="AccountManager.logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Đăng xuất</span>
                        </button>
                    </div>
                </div>

                <!-- Login button (shown when not logged in) -->
                <a href="index.html" class="btn btn-primary" id="loginButton">
                    <i class="fas fa-user"></i>
                    <span>Đăng Nhập</span>
                </a>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container main-content">
        <div class="breadcrumb">
            <a href="index.html">Trang chủ</a>
            <i class="fas fa-chevron-right"></i>
            <span>Tài khoản</span>
        </div>
        
        <!-- Content for logged in users -->
        <div id="accountContent" style="display: none;">
            <div class="account-layout">
                <!-- Sidebar -->
                <div class="account-sidebar">
                    <div class="sidebar-header">
                        <div class="account-avatar" id="accountAvatar">U</div>
                        <div>
                            <h2 class="account-name" id="accountName">User</h2>
                            <div class="account-id" id="accountId">ID: 000001</div>
                        </div>
                    </div>
                    
                    <nav class="sidebar-menu">
                        <button class="menu-item active" data-tab="info">
                            <i class="fas fa-user"></i>
                            Thông tin tài khoản
                        </button>
                        <button class="menu-item" data-tab="balance">
                            <i class="fas fa-wallet"></i>
                            Số dư & Nạp tiền
                        </button>
                        <button class="menu-item" data-tab="history">
                            <i class="fas fa-history"></i>
                            Lịch sử giao dịch
                        </button>
                        <button class="menu-item" data-tab="security">
                            <i class="fas fa-shield-alt"></i>
                            Bảo mật
                        </button>
                    </nav>
                    
                    <button class="btn btn-outline" onclick="AccountManager.logout()" style="width: 100%;">
                        <i class="fas fa-sign-out-alt"></i>
                        Đăng xuất
                    </button>
                </div>
                
                <!-- Content -->
                <div class="account-content">
                    <!-- Account Info Tab -->
                    <div class="tab-content active" id="infoTab">
                        <div class="content-header">
                            <h2 class="content-title">Thông tin tài khoản</h2>
                        </div>
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <label class="info-label">Họ và tên</label>
                                <div class="info-value" id="userFullName">User</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Email</label>
                                <div class="info-value" id="userEmail">user@example.com</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Số điện thoại</label>
                                <div class="info-value" id="userPhone">Chưa cập nhật</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Ngày đăng ký</label>
                                <div class="info-value" id="userRegisterDate">02/08/2025</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">ID tài khoản</label>
                                <div class="info-value" id="userAccountId">000001</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Trạng thái</label>
                                <div class="info-value" style="color: var(--success-color);">Đã xác thực</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Balance Tab -->
                    <div class="tab-content" id="balanceTab">
                        <div class="content-header">
                            <h2 class="content-title">Số dư tài khoản</h2>
                        </div>
                        
                        <div class="balance-card">
                            <div class="balance-amount" id="balanceAmount">0đ</div>
                            <div class="balance-actions">
                                <button class="btn" id="depositBtn">
                                    <i class="fas fa-money-bill-wave"></i>
                                    Nạp tiền
                                </button>
                                <button class="btn" disabled>
                                    <i class="fas fa-hand-holding-usd"></i>
                                    Rút tiền (Sớm ra mắt)
                                </button>
                            </div>
                        </div>
                        
                        <div class="quick-deposit">
                            <h3>Nạp nhanh theo mệnh giá</h3>
                            <div class="quick-amounts">
                                <button class="quick-amount" data-amount="10000">10,000đ</button>
                                <button class="quick-amount" data-amount="20000">20,000đ</button>
                                <button class="quick-amount" data-amount="50000">50,000đ</button>
                                <button class="quick-amount" data-amount="100000">100,000đ</button>
                                <button class="quick-amount" data-amount="200000">200,000đ</button>
                                <button class="quick-amount" data-amount="500000">500,000đ</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- History Tab -->
                    <div class="tab-content" id="historyTab">
                        <div class="content-header">
                            <h2 class="content-title">Lịch sử giao dịch</h2>
                        </div>
                        
                        <div class="history-list" id="historyList">
                            <!-- Transactions will be dynamically inserted here -->
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <h3>Chưa có giao dịch nào</h3>
                                <p>Lịch sử nạp tiền và mua hàng sẽ hiển thị tại đây.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Tab -->
                    <div class="tab-content" id="securityTab">
                        <div class="content-header">
                            <h2 class="content-title">Bảo mật tài khoản</h2>
                        </div>
                        
                        <div class="security-settings">
                            <div class="security-item">
                                <div class="security-info">
                                    <i class="fas fa-lock"></i>
                                    <div>
                                        <h4>Mật khẩu</h4>
                                        <p>••••••••••</p>
                                        <small style="color: rgba(255,255,255,0.6);">Đổi mật khẩu sẽ đăng xuất tất cả thiết bị</small>
                                    </div>
                                </div>
                                <button class="btn btn-outline" id="changePasswordBtn">
                                    <i class="fas fa-edit"></i>
                                    Đổi mật khẩu
                                </button>
                            </div>
                            
                            <div class="security-item">
                                <div class="security-info">
                                    <i class="fas fa-shield-alt"></i>
                                    <div>
                                        <h4>Xác thực 2 bước</h4>
                                        <p style="color: rgba(255,255,255,0.7);">Chưa bật</p>
                                        <small style="color: rgba(255,255,255,0.6);">Tăng cường bảo mật cho tài khoản</small>
                                    </div>
                                </div>
                                <button class="btn btn-outline" disabled>
                                    <i class="fas fa-toggle-off"></i>
                                    Bật (Sớm ra mắt)
                                </button>
                            </div>
                             <!-- ** NÂNG CẤP: Giao diện động cho thiết bị đã đăng nhập ** -->
                            <div class="security-item">
                                <div class="security-info">
                                    <i class="fas fa-laptop"></i>
                                    <div>
                                        <h4>Thiết bị đã đăng nhập</h4>
                                        <p style="color: rgba(255,255,255,0.7);" id="device-count">Đang tải...</p>
                                        <small style="color: rgba(255,255,255,0.6);" id="current-device-info">Trình duyệt hiện tại</small>
                                    </div>
                                </div>
                                <button class="btn btn-outline" id="manageDevicesBtn">
                                    <i class="fas fa-cog"></i>
                                    Quản lý
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Login prompt for non-logged users -->
        <div id="loginPrompt">
            <div class="login-prompt">
                <i class="fas fa-user-lock"></i>
                <h2>Yêu cầu đăng nhập</h2>
                <p>Bạn cần đăng nhập để xem thông tin tài khoản và sử dụng các tính năng</p>
                <div class="login-actions">
                    <a href="index.html" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i>
                        Đăng nhập ngay
                    </a>
                    <a href="index.html" class="btn btn-outline">
                        <i class="fas fa-home"></i>
                        Về trang chủ
                    </a>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Messenger Chat Button -->
    <a href="https://www.messenger.com/e2ee/t/6933504863440412" target="_blank" class="messenger-chat">
        <i class="fab fa-facebook-messenger"></i>
        <div class="tooltip">Chat với chúng tôi</div>
    </a>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-logo">
                    <img src="https://i.ibb.co/k6BvctRR/t-i-xu-ng.jpg" alt="Shop Grow A Garden">
                    <span>Shop Grow A Garden - Giống Cây - Thú Cưng</span>
                </div>
                
                <div>
                    <h3 class="footer-title">Về Chúng Tôi</h3>
                    <p>Chuyên cung cấp dịch vụ, giống cây và thú cưng chất lượng. Giao dịch nhanh chóng, uy tín.</p>
                </div>
                
                <div>
                    <h3 class="footer-title">Liên Hệ</h3>
                    <ul class="footer-links">
                        <li class="footer-link">
                            <a href="mailto:support@shopgrowgarden.com">
                                <i class="fas fa-envelope"></i>
                                <span>Email: support@shopgrowgarden.com</span>
                            </a>
                        </li>
                        <li class="footer-link">
                            <a href="tel:0123456789">
                                <i class="fas fa-phone"></i>
                                <span>Hotline: 0123 456 789</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>© 2025 Shop Grow A Garden. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Deposit Modal -->
    <div class="modal" id="depositModal">
        <div class="modal-content">
            <button class="modal-close" onclick="ModalManager.closeModal('depositModal')">&times;</button>
            <h2 class="modal-title">Nạp tiền bằng thẻ cào</h2>
            
            <div class="card-types">
                <div class="card-type selected" data-type="viettel">
                    <div class="card-logo">VT</div>
                    <span>Viettel</span>
                </div>
                <div class="card-type" data-type="mobifone">
                    <div class="card-logo">MB</div>
                    <span>Mobifone</span>
                </div>
                <div class="card-type" data-type="vinaphone">
                    <div class="card-logo">VP</div>
                    <span>Vinaphone</span>
                </div>
                <div class="card-type" data-type="gate">
                    <div class="card-logo">GT</div>
                    <span>Gate</span>
                </div>
            </div>
            
            <form id="depositForm" novalidate>
                <div class="form-group">
                    <label for="cardNumber">Mã thẻ <small>(Số bí mật sau lớp tráng bạc)</small></label>
                    <input type="text" id="cardNumber" placeholder="Nhập mã thẻ" required minlength="10" maxlength="15" inputmode="numeric">
                    <div class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="cardSerial">Số serial</label>
                    <input type="text" id="cardSerial" placeholder="Nhập số serial in trên thẻ" required minlength="5" maxlength="15" inputmode="text">
                    <div class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="cardAmount">Mệnh giá</label>
                    <select id="cardAmount" required>
                        <option value="">-- Chọn mệnh giá --</option>
                        <option value="10000">10,000đ</option>
                        <option value="20000">20,000đ</option>
                        <option value="50000">50,000đ</option>
                        <option value="100000">100,000đ</option>
                        <option value="200000">200,000đ</option>
                        <option value="500000">500,000đ</option>
                    </select>
                    <div class="error-message"></div>
                </div>
                
                <div class="form-note">
                    <i class="fas fa-info-circle"></i>
                    <span>Vui lòng chọn đúng mệnh giá thẻ. Sai mệnh giá có thể dẫn đến mất thẻ.</span>
                </div>
                
                <button type="submit" class="btn btn-primary btn-submit" id="depositSubmitBtn">
                    <span>
                        <i class="fas fa-check-circle"></i> Nạp tiền
                    </span>
                    <div class="spinner"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <button class="modal-close" onclick="ModalManager.closeModal('changePasswordModal')">&times;</button>
            <h2 class="modal-title">Đổi mật khẩu</h2>
            
            <form id="changePasswordForm" novalidate>
                <div class="form-group password-group">
                    <label for="currentPassword">Mật khẩu hiện tại</label>
                    <input type="password" id="currentPassword" placeholder="Nhập mật khẩu hiện tại" required>
                    <span class="password-toggle" onclick="AccountUtils.togglePassword('currentPassword')">
                        <i class="fas fa-eye"></i>
                    </span>
                    <div class="error-message"></div>
                </div>
                
                <div class="form-group password-group">
                    <label for="newPassword">Mật khẩu mới</label>
                    <input type="password" id="newPassword" placeholder="Nhập mật khẩu mới" required>
                     <span class="password-toggle" onclick="AccountUtils.togglePassword('newPassword')">
                        <i class="fas fa-eye"></i>
                    </span>
                    <!-- Password Strength Meter & Criteria -->
                    <div class="password-strength-container">
                        <div id="passwordStrengthMeter"><div id="passwordStrengthBar"></div></div>
                        <ul id="passwordCriteria">
                            <li data-criterion="length"><i class="fas fa-times-circle"></i> Ít nhất 8 ký tự</li>
                            <li data-criterion="uppercase"><i class="fas fa-times-circle"></i> Có ít nhất 1 chữ hoa</li>
                            <li data-criterion="number"><i class="fas fa-times-circle"></i> Có ít nhất 1 chữ số</li>
                            <li data-criterion="special"><i class="fas fa-times-circle"></i> Có ít nhất 1 ký tự đặc biệt</li>
                        </ul>
                    </div>
                    <div class="error-message"></div>
                </div>
                
                <div class="form-group password-group">
                    <label for="confirmNewPassword">Nhập lại mật khẩu mới</label>
                    <input type="password" id="confirmNewPassword" placeholder="Nhập lại mật khẩu mới" required>
                    <span class="password-toggle" onclick="AccountUtils.togglePassword('confirmNewPassword')">
                        <i class="fas fa-eye"></i>
                    </span>
                    <div class="error-message"></div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-submit">
                    <span>
                        <i class="fas fa-key"></i> Đổi mật khẩu
                    </span>
                    <div class="spinner"></div>
                </button>
            </form>
        </div>
    </div>
    
    <!-- ** MỚI: Modal quản lý thiết bị ** -->
    <div class="modal" id="manageDevicesModal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="ModalManager.closeModal('manageDevicesModal')">&times;</button>
                <h2 class="modal-title">Thiết bị đã đăng nhập</h2>
            </div>
            <div class="modal-body">
                <ul class="device-list" id="deviceList">
                    <!-- Devices will be rendered here by JS -->
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="logoutAllOthersBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Đăng xuất tất cả thiết bị khác</span>
                </button>
            </div>
        </div>
    </div>


    <!-- SCRIPT -->
    <script>
        // ===== UTILITY FUNCTIONS =====
        const AccountUtils = {
            formatPrice: (price) => {
                const num = typeof price === 'string' ? parseInt(price, 10) : price;
                return new Intl.NumberFormat('vi-VN').format(num || 0) + 'đ';
            },
            
            formatDate: (dateString) => {
                if (!dateString) return 'Không xác định';
                return new Date(dateString).toLocaleDateString('vi-VN', {
                    day: '2-digit', month: '2-digit', year: 'numeric'
                });
            },
            
            formatDateTime: (dateString) => {
                if (!dateString) return 'Không xác định';
                return new Date(dateString).toLocaleString('vi-VN', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            },
            
             // **MỚI: Định dạng thời gian tương đối (ví dụ: "5 phút trước")**
            formatRelativeTime: (dateString) => {
                if (!dateString) return 'Không xác định';
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.round((now - date) / 1000);
                const minutes = Math.round(seconds / 60);
                const hours = Math.round(minutes / 60);
                const days = Math.round(hours / 24);

                if (seconds < 60) return "vừa xong";
                if (minutes < 60) return `${minutes} phút trước`;
                if (hours < 24) return `${hours} giờ trước`;
                if (days < 7) return `${days} ngày trước`;
                return AccountUtils.formatDateTime(dateString);
            },
             // **MỚI: Phân tích User-Agent để lấy thông tin trình duyệt và HĐH**
            parseUserAgent(userAgentString) {
                const defaultResult = { browser: 'Unknown', os: 'Unknown', icon: 'fa-question-circle' };
                if (!userAgentString) return defaultResult;
                
                let browser = 'Unknown', os = 'Unknown', icon = 'fa-laptop';

                // OS detection
                if (userAgentString.includes('Windows')) { os = 'Windows'; icon = 'fab fa-windows'; }
                else if (userAgentString.includes('Macintosh') || userAgentString.includes('Mac OS')) { os = 'macOS'; icon = 'fab fa-apple'; }
                else if (userAgentString.includes('Android')) { os = 'Android'; icon = 'fab fa-android'; }
                else if (userAgentString.includes('iPhone') || userAgentString.includes('iPad')) { os = 'iOS'; icon = 'fab fa-apple'; }
                else if (userAgentString.includes('Linux')) { os = 'Linux'; icon = 'fab fa-linux'; }

                // Browser detection
                if (userAgentString.includes('Edg/')) { browser = 'Edge'; icon = 'fab fa-edge'; }
                else if (userAgentString.includes('Chrome/')) { browser = 'Chrome'; icon = 'fab fa-chrome'; }
                else if (userAgentString.includes('Firefox/')) { browser = 'Firefox'; icon = 'fab fa-firefox-browser'; }
                else if (userAgentString.includes('Safari/')) { browser = 'Safari'; icon = 'fab fa-safari'; }

                return { browser, os, icon };
            },
            
            generateUserId: (user) => {
                if (!user || !user._id) return 'N/A';
                return user._id.slice(-6).toUpperCase();
            },

            showToast: (message, type = 'info', duration = 4000) => {
                document.querySelectorAll('.toast').forEach(toast => toast.remove());
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    info: 'fa-info-circle',
                    warning: 'fa-exclamation-triangle'
                };
                toast.innerHTML = `
                    <div>
                        <span><i class="fas ${icons[type]}"></i> ${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" style="background:none; border:none; color:inherit; font-size:18px; cursor:pointer; padding-left: 10px;">&times;</button>
                    </div>`;
                document.body.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 400);
                }, duration);
            },
            
            validateCardForm: (form) => {
                let isValid = true;
                const numberInput = form.querySelector('#cardNumber');
                const serialInput = form.querySelector('#cardSerial');
                const amountSelect = form.querySelector('#cardAmount');
                
                AccountUtils.clearError(numberInput);
                AccountUtils.clearError(serialInput);
                AccountUtils.clearError(amountSelect);
                
                if (!/^[0-9]{10,15}$/.test(numberInput.value)) {
                    AccountUtils.showError(numberInput, 'Mã thẻ phải là số và dài từ 10-15 ký tự.');
                    isValid = false;
                }
                
                if (!/^[a-zA-Z0-9]{5,15}$/.test(serialInput.value)) {
                    AccountUtils.showError(serialInput, 'Số serial phải dài từ 5-15 ký tự chữ hoặc số.');
                     isValid = false;
                }
                
                if (!amountSelect.value) {
                    AccountUtils.showError(amountSelect, 'Vui lòng chọn mệnh giá thẻ.');
                     isValid = false;
                }
                
                return isValid;
            },

            showError: (input, message) => {
                const formGroup = input.closest('.form-group');
                if (!formGroup) return;
                formGroup.classList.add('has-error');
                const errorElement = formGroup.querySelector('.error-message');
                if (errorElement) errorElement.textContent = message;
            },

            clearError: (input) => {
                const formGroup = input.closest('.form-group');
                 if (formGroup) formGroup.classList.remove('has-error');
            },

            togglePassword: (inputId) => {
                const input = document.getElementById(inputId);
                if (!input) return;
                const icon = input.nextElementSibling?.querySelector('i');
                if (!icon) return;
                
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                icon.classList.toggle('fa-eye', !isPassword);
                icon.classList.toggle('fa-eye-slash', isPassword);
            },
            
            checkPasswordStrength: (password) => {
                let score = 0;
                const criteria = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    number: /[0-9]/.test(password),
                    special: /[^A-Za-z0-9]/.test(password),
                };

                if (criteria.length) score++;
                if (criteria.uppercase) score++;
                if (criteria.number) score++;
                if (criteria.special) score++;
                if (password.length >= 12) score++;

                let strength = '';
                if (score <= 1) strength = 'weak';
                else if (score === 2) strength = 'medium';
                else if (score <= 4) strength = 'strong';
                else strength = 'very-strong';

                return { score, criteria, strength };
            }
        };

        // ===== MODAL MANAGER =====
        const ModalManager = {
            showModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => modal.classList.add('show'), 10);
                    document.body.style.overflow = 'hidden';
                }
            },

            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                        
                        const form = modal.querySelector('form');
                        if (form) {
                            form.reset();
                            form.querySelectorAll('.form-group.has-error').forEach(g => g.classList.remove('has-error'));
                            const submitBtn = form.querySelector('.btn-submit');
                            if (submitBtn) {
                                submitBtn.classList.remove('loading');
                                submitBtn.disabled = false;
                            }
                        }
                         if (modalId === 'changePasswordModal') {
                             const strengthBar = document.getElementById('passwordStrengthBar');
                             if(strengthBar) {
                                strengthBar.style.width = '0%';
                                strengthBar.className = '';
                             }
                             document.querySelectorAll('#passwordCriteria li').forEach(li => {
                                li.classList.remove('valid');
                                li.querySelector('i').className = 'fas fa-times-circle';
                            });
                        }
                    }, 300);
                }
            }
        };

        // ===== API MANAGER =====
        const ApiManager = {
            baseUrl: 'https://shop3-t86z.onrender.com/api/v1',
            async call(endpoint, method = 'GET', body = null) {
                const token = localStorage.getItem('token');

                if (!token) {
                     throw new Error('Bạn chưa đăng nhập hoặc phiên đăng nhập đã hết hạn.');
                }

                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const options = { method, headers };
                if (body) options.body = JSON.stringify(body);
                
                const response = await fetch(`${this.baseUrl}${endpoint}`, options);
                
                // ** SỬA: Xử lý response không có content (vd: DELETE 204) **
                if (response.status === 204) {
                     return { status: 'success', data: null };
                }

                let data;
                try {
                    data = await response.json();
                } catch(e) {
                     if (response.ok) return { status: 'success' };
                    throw new Error('Lỗi phản hồi từ máy chủ. Vui lòng thử lại sau.');
                }
                
                if (!response.ok) {
                    const message = data.message || (response.status === 401 ? 'Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại.' : 'Đã có lỗi xảy ra.');
                    throw new Error(message);
                }
                return data;
            }
        };

        // ===== ACCOUNT MANAGER =====
        const AccountManager = {
            user: null,
            isProcessing: false,

            init() {
                this.checkLoginStatus();
                this.addEventListeners();
            },

            async checkLoginStatus() {
                const token = localStorage.getItem('token');
                const userString = localStorage.getItem('user');
                if (token && userString) {
                    try {
                        this.user = JSON.parse(userString);
                        this.renderUI(true); 
                        // ** NÂNG CẤP: Lấy dữ liệu mới nhất và tải lịch sử & thiết bị **
                        const response = await ApiManager.call('/users/me'); 
                        this.user = response.data.user;
                        localStorage.setItem('user', JSON.stringify(this.user));
                        this.renderUI(true);
                        this.loadTransactionHistory();
                        this.loadDeviceSummary(); // ** MỚI **
                    } catch (error) {
                        this.handleApiError(error, 'Kiểm tra đăng nhập');
                    }
                } else {
                    this.renderUI(false);
                }
            },

            renderUI(isLoggedIn) {
                document.getElementById('accountContent').style.display = isLoggedIn ? 'block' : 'none';
                document.getElementById('loginPrompt').style.display = isLoggedIn ? 'none' : 'block';
                document.getElementById('userDropdown').style.display = isLoggedIn ? 'flex' : 'none';
                document.getElementById('loginButton').style.display = isLoggedIn ? 'none' : 'flex';
                
                if (isLoggedIn && this.user) {
                    const avatar = this.user.name?.[0]?.toUpperCase() || 'U';
                    const userId = AccountUtils.generateUserId(this.user);
                    
                    document.getElementById('userAvatar').textContent = avatar;
                    document.getElementById('userName').textContent = this.user.name;
                    document.getElementById('accountAvatar').textContent = avatar;
                    document.getElementById('accountName').textContent = this.user.name;
                    document.getElementById('accountId').textContent = `ID: ${userId}`;
                    document.getElementById('userFullName').textContent = this.user.name;
                    document.getElementById('userEmail').textContent = this.user.email;
                    document.getElementById('userRegisterDate').textContent = AccountUtils.formatDate(this.user.createdAt);
                    document.getElementById('userAccountId').textContent = userId;
                    document.getElementById('balanceAmount').textContent = AccountUtils.formatPrice(this.user.balance);
                }
            },

            async loadTransactionHistory() {
                const listEl = document.getElementById('historyList');
                try {
                    const response = await ApiManager.call('/users/transactions');
                    const transactions = response.data?.transactions || [];
                    
                    if (transactions.length > 0) {
                        listEl.innerHTML = transactions.map(this.createHistoryItemHTML).join('');
                    } else {
                        listEl.innerHTML = `<div class="empty-state">
                                                <i class="fas fa-history"></i>
                                                <h3>Chưa có giao dịch nào</h3>
                                                <p>Lịch sử nạp tiền và mua hàng sẽ hiển thị tại đây.</p>
                                           </div>`;
                    }
                } catch (error) {
                    this.handleApiError(error, 'tải lịch sử giao dịch');
                }
            },
            
             // ** MỚI: Tải thông tin tóm tắt về thiết bị **
            async loadDeviceSummary() {
                 try {
                    const response = await ApiManager.call('/users/sessions');
                    const devices = response.data?.sessions || [];
                    const countEl = document.getElementById('device-count');
                    const infoEl = document.getElementById('current-device-info');

                    if(countEl) countEl.textContent = `${devices.length} thiết bị`;
                    
                    const currentDevice = devices.find(d => d.isCurrent);
                    if (currentDevice && infoEl) {
                        const { browser, os } = AccountUtils.parseUserAgent(currentDevice.deviceInfo);
                        infoEl.textContent = `Thiết bị hiện tại: ${browser} trên ${os}`;
                    }
                } catch (error) {
                    this.handleApiError(error, 'tải thông tin thiết bị');
                }
            },
            // ** MỚI: Tải và hiển thị danh sách thiết bị trong modal **
            async renderDeviceList() {
                const listEl = document.getElementById('deviceList');
                if(!listEl) return;
                listEl.innerHTML = '<p style="color:white; text-align:center;">Đang tải danh sách...</p>';
                 try {
                    const response = await ApiManager.call('/users/sessions');
                    const devices = response.data?.sessions || [];
                    
                    if(devices.length > 0){
                       listEl.innerHTML = devices.map(this.createDeviceItemHTML).join('');
                       // Thêm event listeners cho các nút logout
                       listEl.querySelectorAll('.device-logout-btn').forEach(btn => {
                           btn.addEventListener('click', (e) => {
                               const sessionId = e.currentTarget.dataset.sessionId;
                               this.logoutDevice(sessionId);
                           });
                       });
                    } else {
                        listEl.innerHTML = `<li class="device-item"><p style="color:white;">Không tìm thấy thiết bị nào.</p></li>`;
                    }
                } catch (error) {
                     this.handleApiError(error, 'tải danh sách thiết bị');
                     listEl.innerHTML = `<li class="device-item"><p style="color:var(--danger-color);">Lỗi khi tải danh sách thiết bị.</p></li>`;
                }
            },
            // ** MỚI: Tạo HTML cho một item thiết bị **
            createDeviceItemHTML(device) {
                const { browser, os, icon } = AccountUtils.parseUserAgent(device.deviceInfo);
                const currentTag = device.isCurrent ? '<span class="current-tag">(Thiết bị này)</span>' : '';
                const btnDisabled = device.isCurrent ? 'disabled' : '';
                
                return `<li class="device-item ${device.isCurrent ? 'current-device' : ''}" id="device-${device.id}">
                            <div class="device-icon"><i class="${icon}"></i></div>
                            <div class="device-details">
                                <div class="device-name">${browser} trên ${os} ${currentTag}</div>
                                <div class="device-meta">
                                    <span>IP: ${device.ipAddress}</span> | 
                                    <span>Hoạt động: ${AccountUtils.formatRelativeTime(device.lastUsedAt)}</span>
                                </div>
                            </div>
                            <button class="btn btn-outline device-logout-btn" data-session-id="${device.id}" ${btnDisabled}>
                                <i class="fas fa-sign-out-alt"></i> Đăng xuất
                            </button>
                        </li>`;
            },
             // ** MỚI: Xử lý đăng xuất 1 thiết bị **
            async logoutDevice(sessionId) {
                if(!confirm('Bạn có chắc chắn muốn đăng xuất khỏi thiết bị này không?')) return;
                
                try {
                    await ApiManager.call(`/users/sessions/${sessionId}`, 'DELETE');
                    AccountUtils.showToast('Đăng xuất thiết bị thành công.', 'success');
                    // Xóa item khỏi UI
                    const deviceItem = document.getElementById(`device-${sessionId}`);
                    if(deviceItem) deviceItem.remove();
                    this.loadDeviceSummary(); // Cập nhật lại summary
                } catch(error) {
                     this.handleApiError(error, 'đăng xuất thiết bị');
                }
            },
            // ** MỚI: Xử lý đăng xuất các thiết bị khác **
             async logoutAllOtherDevices() {
                if(!confirm('Bạn có chắc chắn muốn đăng xuất khỏi tất cả các thiết bị khác không?')) return;
                 try {
                    await ApiManager.call('/users/sessions/all-but-current', 'DELETE');
                    AccountUtils.showToast('Đã đăng xuất tất cả thiết bị khác.', 'success');
                    // Tải lại danh sách, chỉ còn thiết bị hiện tại
                    this.renderDeviceList();
                    this.loadDeviceSummary(); // Cập nhật lại summary
                } catch(error) {
                     this.handleApiError(error, 'đăng xuất các thiết bị khác');
                }
            },


            createHistoryItemHTML(t) {
                const isDeposit = t.type === 'deposit';

                const statusConfig = {
                    success: {
                        class: 'success',
                        icon: isDeposit ? 'fa-plus' : 'fa-shopping-cart',
                        color: isDeposit ? 'var(--success-color)' : 'var(--primary-color)',
                        text: 'Thành công'
                    },
                    failed: {
                        class: 'failed',
                        icon: 'fa-times-circle',
                        color: 'var(--gray-color)',
                        text: t.description || 'Thất bại'
                    },
                    pending: {
                        class: 'pending',
                        icon: 'fa-spinner fa-spin',
                        color: 'var(--gray-color)',
                        text: 'Đang xử lý...'
                    }
                };

                const config = statusConfig[t.status] || statusConfig.pending;
                const amountPrefix = isDeposit ? '+' : '-';
                const transactionId = t._id || `pending-${Date.now()}`;
                const title = isDeposit ? `Nạp thẻ ${t.details?.cardType || ''}`.trim() : t.description || 'Mua hàng';
                const date = AccountUtils.formatDateTime(t.createdAt || new Date());
                
                const statusTextColor = t.status === 'failed' ? 'var(--danger-color)' : t.status === 'pending' ? 'var(--gray-color)' : config.color;
                const statusTextHTML = `<div class="history-status" style="color: ${statusTextColor};">${config.text}</div>`;

                return `<div class="history-item ${config.class}" id="transaction-${transactionId}">
                            <div class="history-icon ${config.class}"><i class="fas ${config.icon}"></i></div>
                            <div class="history-details">
                                <div class="history-title">${title}</div>
                                <div class="history-date">${date}</div>
                                ${statusTextHTML}
                            </div>
                            <div class="history-amount" style="color:${config.color};">${amountPrefix}${AccountUtils.formatPrice(t.amount)}</div>
                        </div>`;
            },
            
            addTransactionToHistory(transaction) {
                const listEl = document.getElementById('historyList');
                const emptyState = listEl.querySelector('.empty-state');
                if (emptyState) emptyState.remove();
                listEl.insertAdjacentHTML('afterbegin', this.createHistoryItemHTML(transaction));
            },
            
            updateTransactionInHistory(id, newTransactionData) {
                 const itemEl = document.getElementById(`transaction-${id}`);
                 if (itemEl) itemEl.outerHTML = this.createHistoryItemHTML(newTransactionData);
            },

            handleApiError(error, context = 'thao tác') {
                const message = error.message || `Lỗi không xác định khi ${context}.`;
                // **Sửa:** Logout khi có lỗi 401
                 if (error.message.includes('hết hạn') || error.message.includes('terminated')) {
                     AccountUtils.showToast(message, 'error');
                     this.logout(true, false);
                     return true;
                }
                 AccountUtils.showToast(message, 'error');
                return false;
            },
            
            addEventListeners() {
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', (e) => this.switchTab(e.currentTarget.dataset.tab));
                });
                document.getElementById('depositBtn')?.addEventListener('click', () => ModalManager.showModal('depositModal'));
                document.getElementById('changePasswordBtn')?.addEventListener('click', () => ModalManager.showModal('changePasswordModal'));
                
                // ** MỚI: Listener cho nút quản lý thiết bị và modal **
                 document.getElementById('manageDevicesBtn')?.addEventListener('click', () => {
                    ModalManager.showModal('manageDevicesModal');
                    this.renderDeviceList();
                 });
                 document.getElementById('logoutAllOthersBtn')?.addEventListener('click', () => {
                     this.logoutAllOtherDevices();
                 });

                document.querySelectorAll('.quick-amount').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const amount = e.currentTarget.dataset.amount;
                        const selectEl = document.getElementById('cardAmount');
                        if (selectEl) selectEl.value = amount;
                        ModalManager.showModal('depositModal');
                    });
                });
                document.querySelectorAll('.card-type').forEach(card => {
                    card.addEventListener('click', e => {
                        document.querySelector('.card-type.selected')?.classList.remove('selected');
                        e.currentTarget.classList.add('selected');
                    });
                });
                document.getElementById('depositForm')?.addEventListener('submit', (e) => { e.preventDefault(); this.processDeposit(e.target); });
                document.getElementById('changePasswordForm')?.addEventListener('submit', (e) => { e.preventDefault(); this.changePassword(e.target); });

                document.getElementById('newPassword')?.addEventListener('input', this.updatePasswordStrengthUI);
            },

            updatePasswordStrengthUI() {
                const password = this.value;
                const { criteria, strength } = AccountUtils.checkPasswordStrength(password);
                
                const strengthBar = document.getElementById('passwordStrengthBar');
                const strengthLevels = { weak: '25%', medium: '50%', strong: '75%', 'very-strong': '100%' };

                strengthBar.style.width = strengthLevels[strength] || '0%';
                strengthBar.className = strength;

                for (const key in criteria) {
                    const li = document.querySelector(`#passwordCriteria [data-criterion="${key}"]`);
                    const icon = li.querySelector('i');
                    if (criteria[key]) {
                        li.classList.add('valid');
                        icon.className = 'fas fa-check-circle';
                    } else {
                        li.classList.remove('valid');
                        icon.className = 'fas fa-times-circle';
                    }
                }
            },

            async processDeposit(form) {
                // CORE FIX: Ensure validation is checked before proceeding
                if (this.isProcessing || !AccountUtils.validateCardForm(form)) return;
                
                this.isProcessing = true;
                const submitBtn = form.querySelector('.btn-submit');
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;

                const selectedTypeEl = document.querySelector('#depositModal .card-type.selected');
                
                if (!selectedTypeEl) {
                    AccountUtils.showToast('Vui lòng chọn một loại thẻ.', 'error');
                    this.isProcessing = false;
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                    return;
                }
            
                const data = {
                    cardType: selectedTypeEl.dataset.type,
                    cardNumber: form.querySelector('#cardNumber').value,
                    cardSerial: form.querySelector('#cardSerial').value,
                    amount: form.querySelector('#cardAmount').value
                };
                
                const pendingId = `pending-${Date.now()}`;
                const pendingTransaction = {
                    _id: pendingId, type: 'deposit', status: 'pending',
                    amount: data.amount, details: { cardType: data.cardType }, createdAt: new Date()
                };
                this.addTransactionToHistory(pendingTransaction);
                ModalManager.closeModal('depositModal');

                try {
                    const response = await ApiManager.call('/users/deposit/card', 'POST', data);
                    const finalTransaction = response.data.transaction;
                    
                    this.user.balance = finalTransaction.user.balance;
                    localStorage.setItem('user', JSON.stringify(this.user));
                    this.renderUI(true);
                    
                    AccountUtils.showToast(response.message || 'Nạp thẻ thành công!', 'success');
                    this.updateTransactionInHistory(pendingId, finalTransaction);
                } catch (error) {
                    if (!this.handleApiError(error, 'nạp thẻ')) {
                         this.updateTransactionInHistory(pendingId, { ...pendingTransaction, status: 'failed', description: error.message });
                    }
                } finally {
                    this.isProcessing = false; 
                }
            },
            
            async changePassword(form) {
                if (this.isProcessing) return;
                
                const currentPass = form.querySelector('#currentPassword');
                const newPass = form.querySelector('#newPassword');
                const confirmPass = form.querySelector('#confirmNewPassword');
                [currentPass, newPass, confirmPass].forEach(AccountUtils.clearError);
                
                let isValid = true;
                
                const strengthCheck = AccountUtils.checkPasswordStrength(newPass.value);
                if (strengthCheck.score < 3) {
                    AccountUtils.showError(newPass, 'Mật khẩu của bạn chưa đủ mạnh. Vui lòng đáp ứng các tiêu chí.');
                    isValid = false;
                }

                if (newPass.value !== confirmPass.value) {
                     AccountUtils.showError(confirmPass, 'Mật khẩu mới không khớp.');
                     isValid = false;
                }
                if (!isValid) return;

                this.isProcessing = true;
                const submitBtn = form.querySelector('.btn-submit');
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
                
                try {
                    // **Sửa**: Khi đổi pass thành công, backend sẽ trả về token và sessionId mới
                    const response = await ApiManager.call('/users/updateMyPassword', 'PATCH', {
                        passwordCurrent: currentPass.value,
                        password: newPass.value,
                        passwordConfirm: confirmPass.value
                    });
                     // Lưu lại token và session mới
                    localStorage.setItem('token', response.token);
                    localStorage.setItem('sessionId', response.sessionId);
                    
                    AccountUtils.showToast('Đổi mật khẩu thành công! Các phiên đăng nhập khác đã được đăng xuất.', 'success');
                    ModalManager.closeModal('changePasswordModal');
                    this.loadDeviceSummary(); // Cập nhật lại summary thiết bị
                } catch (error) {
                    if (!this.handleApiError(error, 'đổi mật khẩu')) {
                         const message = error.message;
                        // Phân tích lỗi cụ thể hơn
                        if(/incorrect password/i.test(message)){
                           AccountUtils.showError(currentPass, 'Mật khẩu hiện tại không chính xác.');
                        } else {
                           AccountUtils.showError(newPass, message);
                        }
                    }
                } finally {
                    this.isProcessing = false;
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                }
            },
            
            switchTab(tabId) {
                document.querySelector('.menu-item.active')?.classList.remove('active');
                document.querySelector(`[data-tab="${tabId}"]`)?.classList.add('active');
                
                document.querySelector('.tab-content.active')?.classList.remove('active');
                document.getElementById(`${tabId}Tab`)?.classList.add('active');
            },

            async logout(withRedirect = true, callServer = false) {
                 // **SỬA:** Không cần gọi server khi logout nữa, chỉ cần xóa thông tin phía client.
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('sessionId'); // **MỚI**
                this.user = null;
                this.renderUI(false);
                
                if (withRedirect) {
                    AccountUtils.showToast('Đăng xuất thành công, đang chuyển hướng...', 'info');
                    setTimeout(() => window.location.href = 'index.html', 1500);
                }
            }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => AccountManager.init());
    </script>
</body>
</html>
